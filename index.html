<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SISTEMA VENTAS - OFICIAL</title>

<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
*{box-sizing:border-box}
body{font-family:'Segoe UI',sans-serif;background:#001220;margin:0}
.header{background:#003566;color:#fff;padding:15px;text-align:center;border-bottom:4px solid #ffc300}
.container{max-width:450px;margin:auto;background:#fff;padding:20px;min-height:100vh}
.card{background:#f8f9fa;border:1px solid #dee2e6;padding:15px;border-radius:12px;margin-bottom:15px}
label{font-size:11px;font-weight:bold;color:#003566;text-transform:uppercase;display:block;margin-bottom:5px}
input,select,button{width:100%;padding:12px;margin-bottom:12px;border:1px solid #ccc;border-radius:8px;font-size:15px}
button{background:#003566;color:#fff;font-weight:bold;border:none;cursor:pointer}
button:active{transform:scale(.98)}
.btn-save{background:#28a745;font-size:18px}
.btn-excel{background:#217346;height:55px;font-size:16px}
.btn-delete{background:#dc3545;padding:5px 10px;font-size:10px;margin:0}
.hidden{display:none}
.reloj{font-size:28px;font-weight:bold;color:#ffc300;text-align:center;margin:10px 0}
.tabla-scroll{overflow-x:auto;width:100%;margin-top:15px;border:1px solid #ddd;border-radius:8px;background:white}
table{border-collapse:collapse;min-width:900px;font-size:10px;width:100%}
th,td{border:1px solid #ddd;padding:8px;text-align:center;white-space:nowrap}
th{background:#003566;color:#fff;text-transform:uppercase;font-size:9px}
tr:nth-child(even){background:#f8f9fa}
.stats-bar{display:flex;justify-content:space-around;background:#003566;color:#fff;padding:10px;border-radius:8px;margin-bottom:15px;font-size:12px}
.stats-bar strong{display:block;font-size:18px;color:#ffc300}
</style>
</head>

<body onload="inicio()">

<!-- LOGIN -->
<div id="lSec">
<div class="reloj" id="rel"></div>
<input type="email" id="u" placeholder="Correo">
<input type="password" id="p" placeholder="ContraseÃ±a">
<button onclick="entrar()">ENTRAR</button>
</div>

<!-- SISTEMA -->
<div id="mSec" class="hidden">
<div class="header"><h3>SISTEMA DE VENTAS TELCEL</h3></div>

<div class="container">

<div class="stats-bar">
<div><strong id="statTotal">0</strong>Total</div>
<div><strong id="statHoy">0</strong>Hoy</div>
<div><strong id="statKit">0</strong>KIT</div>
<div><strong id="statChip">0</strong>CHIP</div>
</div>

<form id="fReg">

<div class="card">
<label>NUM. CELULAR</label>
<input id="iTel" required>

<label>ICCID</label>
<input id="iIcc" required>

<label>Tipo</label>
<select id="iTipo" onchange="menuInteractivo()" required>
<option value="">Seleccionar</option>
<option>KIT</option>
<option>CHIP</option>
<option>PORTA</option>
<option>RENUEVATE</option>
</select>
</div>

<div id="seccionEquipo" class="card hidden">
<label>IMEI</label>
<input id="iIme">
<label>MARCA</label>
<input id="iMarca">
<label>MODELO</label>
<input id="iMod">
</div>

<div class="card">
<label># TIENDA</label>
<input id="iTiendaNum" required>

<label>CADENA</label>
<input id="iCadena" required>

<label>NOMBRE TIENDA</label>
<input id="iTiendaNombre" required>

<label>PROMOTOR</label>
<input id="iProm" required>

<label>FECHA</label>
<input type="date" id="iFec" required>
</div>

<button class="btn-save">GUARDAR</button>
</form>

<div class="tabla-scroll">
<table id="tVistas">
<thead>
<tr>
<th>NUM. CELULAR</th>
<th>IMEI</th>
<th>ICCID</th>
<th>TIPO</th>
<th>TIENDA</th>
<th>CADENA</th>
<th>NOMBRE TIENDA</th>
<th>PROMOTOR</th>
<th>FECHA</th>
<th>MARCA</th>
<th>MODELO</th>
<th>ACCION</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<button class="btn-excel" onclick="bajarExcel()">DESCARGAR EXCEL</button>
</div>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSy",
databaseURL:"https://ventastelcel4029-default-rtdb.firebaseio.com"
}

let uA="",db

function inicio(){
setInterval(()=>rel.innerText=new Date().toLocaleTimeString(),1000)
iFec.value=new Date().toISOString().split('T')[0]
firebase.initializeApp(firebaseConfig)
db=firebase.database()
}

function entrar(){
uA=u.value
lSec.className="hidden"
mSec.className=""
pintarTabla()
}

fReg.onsubmit=e=>{
e.preventDefault()

const venta={
tel:iTel.value,
iccid:iIcc.value,
tipo:iTipo.value,
tiendaNum:iTiendaNum.value,
cadena:iCadena.value,
tiendaNom:iTiendaNombre.value,
prom:iProm.value,
fec:iFec.value,
imei:iIme.value||"",
marca:iMarca.value||"",
mod:iMod.value||""
}

db.ref('ventas/'+btoa(uA)).push(venta).then(()=>{
fReg.reset()
iFec.value=new Date().toISOString().split('T')[0]
menuInteractivo()
pintarTabla()
})
}

function pintarTabla(){
db.ref('ventas/'+btoa(uA)).once('value',s=>{
const tb=document.querySelector('#tVistas tbody')
tb.innerHTML=""
s.forEach(c=>{
const v=c.val()
tb.innerHTML+=`
<tr>
<td>${v.tel}</td>
<td>${v.imei}</td>
<td>${v.iccid}</td>
<td>${v.tipo}</td>
<td>${v.tiendaNum}</td>
<td>${v.cadena}</td>
<td>${v.tiendaNom}</td>
<td>${v.prom}</td>
<td>${v.fec}</td>
<td>${v.marca}</td>
<td>${v.mod}</td>
<td><button class="btn-delete" onclick="borrar('${c.key}')">X</button></td>
</tr>`
})
})
}

function borrar(id){
db.ref('ventas/'+btoa(uA)+'/'+id).remove().then(pintarTabla)
}

function menuInteractivo(){
const eq=iTipo.value==="KIT"||iTipo.value==="RENUEVATE"
seccionEquipo.classList.toggle("hidden",!eq)
}

/* ==============================
   EXPORTAR EXCEL FORMATO IGUAL
   ============================== */

function bajarExcel(){

db.ref('ventas/'+btoa(uA)).once('value',s=>{

const raw=Object.values(s.val()||{})

const datos=raw.map(v=>({
"NUM. CELULAR":v.tel,
"IMEI":v.imei||"",
"ICCID":v.iccid,
"Renuevate / Kit / Chip / Porta":v.tipo,
"# TIENDA / Determinante":v.tiendaNum,
"SOLO NOMBRE DE LA CADENA":v.cadena,
"SOLO NOMBRE DE TIENDA SIN CADENA":v.tiendaNom,
"NOMBRE COMPLETO PROMOTOR":v.prom,
"FECHA DE ACTIVACION":v.fec,
"MARCA":v.marca||"",
"MODELO":v.mod||""
}))

const headers=[
"NUM. CELULAR",
"IMEI",
"ICCID",
"Renuevate / Kit / Chip / Porta",
"# TIENDA / Determinante",
"SOLO NOMBRE DE LA CADENA",
"SOLO NOMBRE DE TIENDA SIN CADENA",
"NOMBRE COMPLETO PROMOTOR",
"FECHA DE ACTIVACION",
"MARCA",
"MODELO"
]

const ws=XLSX.utils.aoa_to_sheet([headers])
XLSX.utils.sheet_add_json(ws,datos,{origin:"A2",skipHeader:true})

ws["!cols"]=[
{wch:18},{wch:20},{wch:22},{wch:28},{wch:24},
{wch:28},{wch:32},{wch:30},{wch:22},{wch:18},{wch:18}
]

const wb=XLSX.utils.book_new()
XLSX.utils.book_append_sheet(wb,ws,"Registro")
XLSX.writeFile(wb,"Formato_Registro_Celulares.xlsx")

})
}
</script>
</body>
</html>