<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Ventas Telcel Pro</title>

<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{margin:0;font-family:Segoe UI;background:#001d3d;color:white}
.app{max-width:480px;margin:auto;padding:20px}
.card{background:rgba(255,255,255,.08);padding:15px;border-radius:12px;margin-bottom:12px}
button{width:100%;padding:12px;border:none;border-radius:8px;font-weight:bold}
.btn-main{background:#ffc300;color:#003566}
.btn-excel{background:#1f7a3f;color:white}
.hidden{display:none}
</style>
</head>

<body onload="inicio()">

<div id="loginBox" class="app">
<input id="u" placeholder="Correo">
<input id="p" type="password" placeholder="Contraseña">
<button onclick="entrar()">Entrar</button>
</div>

<div id="appBox" class="app hidden">

<form id="fReg" class="card">
<input id="iTel" placeholder="NUM CELULAR" required>
<input id="iIcc" placeholder="ICCID" required>
<select id="iTipo" required>
<option value="">Tipo</option>
<option>KIT</option>
<option>CHIP</option>
<option>PORTA</option>
<option>RENUEVATE</option>
</select>
<input id="iIme" placeholder="IMEI">
<input id="iMarca" placeholder="MARCA">
<input id="iMod" placeholder="MODELO">
<input id="iTiendaNum" placeholder="TIENDA" required>
<input id="iCadena" placeholder="CADENA" required>
<input id="iTiendaNombre" placeholder="NOMBRE TIENDA" required>
<input id="iProm" placeholder="PROMOTOR" required>
<input type="date" id="iFec" required>
<button class="btn-main">Guardar Venta</button>
</form>

<button class="btn-excel" onclick="bajarExcel()">EXPORTAR EXCEL</button>
<button onclick="salir()">CERRAR SESION</button>

</div>

<script>
const firebaseConfig={
apiKey:"AIzaSy",
databaseURL:"https://ventastelcel4029-default-rtdb.firebaseio.com"
}

let uA="",db

function inicio(){
firebase.initializeApp(firebaseConfig)
db=firebase.database()
iFec.value=new Date().toISOString().split('T')[0]
}

function entrar(){
uA=u.value
loginBox.classList.add("hidden")
appBox.classList.remove("hidden")
}

function salir(){
location.reload()
}

fReg.onsubmit=e=>{
e.preventDefault()

const v={
tel:iTel.value,
iccid:iIcc.value,
tipo:iTipo.value,
tiendaNum:iTiendaNum.value,
cadena:iCadena.value,
tiendaNom:iTiendaNombre.value,
prom:iProm.value,
fec:iFec.value,
imei:iIme.value||"",
marca:iMarca.value||"",
mod:iMod.value||""
}

db.ref('ventas/'+btoa(uA)).push(v).then(()=>{
fReg.reset()
iFec.value=new Date().toISOString().split('T')[0]
alert("Venta guardada")
})
}

/* ================================
   PLANTILLA EXCEL INTERNA REAL
   ================================ */

const PLANTILLA_BASE64 = `
UEsDBBQABgAIAAAAIQD...
(IMPORTANTE: aquí va toda la cadena base64 EXACTA — no la cortes)
...AAAA==
`.replace(/\s/g,'')

function base64ToArrayBuffer(base64){
const binary=atob(base64)
const len=binary.length
const bytes=new Uint8Array(len)
for(let i=0;i<len;i++) bytes[i]=binary.charCodeAt(i)
return bytes.buffer
}

async function bajarExcel(){

const buffer = base64ToArrayBuffer(PLANTILLA_BASE64)
const wb = XLSX.read(buffer,{type:"array"})
const ws = wb.Sheets[wb.SheetNames[0]]

const snap=await db.ref('ventas/'+btoa(uA)).once('value')

let fila=2
Object.values(snap.val()||{}).forEach(v=>{
ws["A"+fila]={t:"s",v:v.tel}
ws["B"+fila]={t:"s",v:v.imei}
ws["C"+fila]={t:"s",v:v.iccid}
ws["D"+fila]={t:"s",v:v.tipo}
ws["E"+fila]={t:"s",v:v.tiendaNum}
ws["F"+fila]={t:"s",v:v.cadena}
ws["G"+fila]={t:"s",v:v.tiendaNom}
ws["H"+fila]={t:"s",v:v.prom}
ws["I"+fila]={t:"s",v:v.fec}
ws["J"+fila]={t:"s",v:v.marca}
ws["K"+fila]={t:"s",v:v.mod}
fila++
})

XLSX.writeFile(wb,"Reporte_Ventas_Telcel.xlsx")
}
</script>

</body>
</html>