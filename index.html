<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SISTEMA VENTAS - OFICIAL</title>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
* { box-sizing: border-box; }
body { font-family: 'Segoe UI', sans-serif; background: #001220; margin: 0; }
.header { background: #003566; color: #fff; padding: 15px; text-align: center; border-bottom: 4px solid #ffc300; }
.container { max-width: 450px; margin: auto; background: #fff; padding: 20px; min-height: 100vh; }
.card { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
label { font-size: 11px; font-weight: bold; color: #003566; text-transform: uppercase; display: block; margin-bottom: 5px; }
input, select, button { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 15px; }
button { background: #003566; color: #fff; font-weight: bold; border: none; cursor: pointer; }
button:active { transform: scale(0.98); }
.btn-reg { background: #28a745; }
.btn-save { background: #28a745; font-size: 18px; }
.btn-excel { background: #217346; height: 55px; font-size: 16px; }
.btn-delete { background: #dc3545; padding: 5px 10px; font-size: 10px; margin: 0; }
.hidden { display: none; }
.reloj { font-size: 28px; font-weight: bold; color: #ffc300; text-align: center; margin: 10px 0; }
.tabla-scroll { overflow-x: auto; width: 100%; margin-top: 15px; border: 1px solid #ddd; border-radius: 8px; background: white; }
table { border-collapse: collapse; min-width: 900px; font-size: 10px; width: 100%; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: center; white-space: nowrap; }
th { background: #003566; color: #fff; text-transform: uppercase; font-size: 9px; }
tr:nth-child(even) { background: #f8f9fa; }
.login-container { max-width: 400px; margin: auto; padding: 40px 20px; text-align: center; }
.login-logo { width: 160px; margin-bottom: 20px; }
.login-box { background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
.login-box h3 { color: #003566; margin-bottom: 20px; }
.login-box input { margin-bottom: 15px; }
.link-text { color: #003566; cursor: pointer; text-decoration: underline; font-size: 13px; }
.stats-bar { display: flex; justify-content: space-around; background: #003566; color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; }
.stats-bar div { text-align: center; }
.stats-bar strong { display: block; font-size: 18px; color: #ffc300; }
</style>
</head>
<body onload="inicio()">

<!-- SECCION LOGIN -->
<div id="lSec" class="login-container">
  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Telcel_logo.svg/1200px-Telcel_logo.svg.png" class="login-logo">
  <div id="rel" class="reloj">00:00:00</div>
  
  <div id="divLogin" class="login-box">
    <h3>INICIAR SESION</h3>
    <input type="email" id="u" placeholder="Correo electronico">
    <input type="password" id="p" placeholder="Contraseña">
    <button onclick="entrar()">ENTRAR</button>
    <hr>
    <p class="link-text" onclick="verSeccion('divReg')">Crear nueva cuenta</p>
  </div>
  
  <div id="divReg" class="login-box hidden">
    <h3>CREAR CUENTA</h3>
    <input type="email" id="regEmail" placeholder="Correo electronico">
    <input type="password" id="regPass" placeholder="Contraseña">
    <button class="btn-reg" onclick="registrarUsuario()">REGISTRAR</button>
    <p class="link-text" onclick="verSeccion('divLogin')">Volver al login</p>
  </div>
</div>

<!-- SECCION PRINCIPAL -->
<div id="mSec" class="hidden">
  <div class="header">
    <h3>SISTEMA DE VENTAS TELCEL</h3>
    <small style="color:#ffc300">NUBE ACTIVA</small>
  </div>
  
  <div class="container">
    
    <!-- ESTADISTICAS -->
    <div class="stats-bar">
      <div><strong id="statTotal">0</strong>Total</div>
      <div><strong id="statHoy">0</strong>Hoy</div>
      <div><strong id="statKit">0</strong>KIT</div>
      <div><strong id="statChip">0</strong>CHIP</div>
    </div>
    
    <form id="fReg">
      <!-- DATOS DEL TRAMITE -->
      <div class="card">
        <label>NUM. CELULAR</label>
        <input type="text" id="iTel" maxlength="10" placeholder="10 digitos" required>
        
        <label>ICCID</label>
        <input type="text" id="iIcc" maxlength="19" placeholder="19 digitos" required>
        
        <label>Renuevate / Kit / Chip / Porta</label>
        <select id="iTipo" onchange="menuInteractivo()" required>
          <option value="">Seleccionar...</option>
          <option value="KIT">KIT</option>
          <option value="CHIP">CHIP</option>
          <option value="PORTA">PORTA</option>
          <option value="RENUEVATE">RENUEVATE</option>
        </select>
      </div>
      
      <!-- DATOS DEL EQUIPO (SOLO KIT Y RENUEVATE) -->
      <div id="seccionEquipo" class="card hidden">
        <label>IMEI</label>
        <input type="text" id="iIme" maxlength="15" placeholder="15 digitos">
        
        <label>MARCA</label>
        <input type="text" id="iMarca" placeholder="Ej: SAMSUNG, XIAOMI, MOTOROLA">
        
        <label>MODELO</label>
        <input type="text" id="iMod" placeholder="Ej: GALAXY A14, REDMI NOTE 12">
      </div>
      
      <!-- DATOS DE TIENDA Y PROMOTOR -->
      <div class="card">
        <label># TIENDA / Determinante</label>
        <input type="text" id="iTiendaNum" placeholder="Numero de tienda" required>
        
        <label>SOLO NOMBRE DE LA CADENA</label>
        <input type="text" id="iCadena" placeholder="Ej: ELEKTRA, COPPEL, WALMART" required>
        
        <label>SOLO NOMBRE DE TIENDA SIN CADENA</label>
        <input type="text" id="iTiendaNombre" placeholder="Ej: PLAZA CENTRAL, SUCURSAL NORTE" required>
        
        <label>NOMBRE COMPLETO PROMOTOR</label>
        <input type="text" id="iProm" placeholder="Nombre completo" required>
        
        <label>FECHA DE ACTIVACION</label>
        <input type="date" id="iFec" required>
      </div>
      
      <button type="submit" class="btn-save">GUARDAR VENTA</button>
    </form>
    
    <!-- TABLA DE REGISTROS -->
    <h4 style="color:#003566; margin: 20px 0 10px 0;">ULTIMOS REGISTROS</h4>
    <div class="tabla-scroll">
      <table id="tVistas">
        <thead>
          <tr>
            <th>NUM. CELULAR</th>
            <th>IMEI</th>
            <th>ICCID</th>
            <th>Renuevate/Kit/Chip/Porta</th>
            <th>#TIENDA/Determinante</th>
            <th>SOLO NOMBRE DE LA CADENA</th>
            <th>SOLO NOMBRE DE TIENDA SIN CADENA</th>
            <th>NOMBRE COMPLETO PROMOTOR</th>
            <th>FECHA DE ACTIVACION</th>
            <th>MARCA</th>
            <th>MODELO</th>
            <th>ACCION</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    
    <button class="btn-excel" onclick="bajarExcel()" style="margin-top:20px">DESCARGAR EXCEL</button>
    <button onclick="salir()" style="background:#6c757d;margin-top:10px">CERRAR SESION</button>
    
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD4UK_j8UxMwOCtrtXIYftB",
  databaseURL: "https://ventastelcel4029-default-rtdb.firebaseio.com"
};

let uA = "", db;

function inicio() {
  setInterval(() => rel.innerText = new Date().toLocaleTimeString(), 1000);
  iFec.value = new Date().toISOString().split('T')[0];
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  const s = localStorage.getItem('ses_actual');
  if (s) { uA = s; mostrar(); }
}

function registrarUsuario() {
  const c = regEmail.value.trim().toLowerCase();
  const p2 = regPass.value.trim();
  if (!c || !p2) return alert("Completa todos los campos");
  db.ref('usuarios/' + btoa(c)).set({ p: p2 }).then(() => {
    alert("Cuenta creada exitosamente");
    verSeccion('divLogin');
  });
}

function entrar() {
  const c = u.value.trim().toLowerCase();
  const p2 = p.value.trim();
  db.ref('usuarios/' + btoa(c)).once('value').then(s => {
    if (s.exists() && s.val().p === p2) {
      uA = c;
      localStorage.setItem('ses_actual', uA);
      mostrar();
    } else {
      alert("Correo o contraseña incorrectos");
    }
  });
}

function mostrar() {
  lSec.className = 'hidden';
  mSec.className = '';
  pintarTabla();
  actualizarStats();
}

fReg.onsubmit = e => {
  e.preventDefault();
  
  const venta = {
    tel: iTel.value.trim(),
    iccid: iIcc.value.trim(),
    tipo: iTipo.value,
    tiendaNum: iTiendaNum.value.trim(),
    cadena: iCadena.value.toUpperCase().trim(),
    tiendaNom: iTiendaNombre.value.toUpperCase().trim(),
    prom: iProm.value.toUpperCase().trim(),
    fec: iFec.value,
    imei: iIme.value.trim() || "",
    marca: iMarca.value.toUpperCase().trim() || "",
    mod: iMod.value.toUpperCase().trim() || ""
  };

  db.ref('ventas/' + btoa(uA)).push(venta).then(() => {
    alert("Venta guardada correctamente");
    fReg.reset();
    iFec.value = new Date().toISOString().split('T')[0];
    menuInteractivo();
    pintarTabla();
    actualizarStats();
  });
};

function pintarTabla() {
  db.ref('ventas/' + btoa(uA)).limitToLast(20).once('value', s => {
    const tb = document.querySelector('#tVistas tbody');
    tb.innerHTML = "";
    const datos = [];
    s.forEach(c => { datos.push({ key: c.key, val: c.val() }); });
    datos.reverse().forEach(item => {
      const v = item.val;
      const fEx = v.fec ? v.fec.split('-').reverse().join('/') : "";
      tb.innerHTML += `<tr>
        <td>${v.tel}</td>
        <td>${v.imei || '-'}</td>
        <td>${v.iccid}</td>
        <td>${v.tipo}</td>
        <td>${v.tiendaNum}</td>
        <td>${v.cadena}</td>
        <td>${v.tiendaNom}</td>
        <td>${v.prom}</td>
        <td>${fEx}</td>
        <td>${v.marca || '-'}</td>
        <td>${v.mod || '-'}</td>
        <td><button class="btn-delete" onclick="borrar('${item.key}')">X</button></td>
      </tr>`;
    });
  });
}

function actualizarStats() {
  db.ref('ventas/' + btoa(uA)).once('value', s => {
    let total = 0, hoy = 0, kits = 0, chips = 0;
    const hoyStr = new Date().toISOString().split('T')[0];
    s.forEach(c => {
      const v = c.val();
      total++;
      if (v.fec === hoyStr) hoy++;
      if (v.tipo === 'KIT') kits++;
      if (v.tipo === 'CHIP') chips++;
    });
    statTotal.innerText = total;
    statHoy.innerText = hoy;
    statKit.innerText = kits;
    statChip.innerText = chips;
  });
}

function borrar(id) {
  if (confirm("Eliminar este registro?")) {
    db.ref('ventas/' + btoa(uA) + '/' + id).remove().then(() => {
      pintarTabla();
      actualizarStats();
    });
  }
}

function bajarExcel() {
  db.ref('ventas/' + btoa(uA)).once('value', s => {
    const rawData = Object.values(s.val() || {});
    const dataFormateada = rawData.map(v => {
      const f = v.fec ? v.fec.split('-').reverse().join('/') : "";
      return {
        "NUM. CELULAR": v.tel,
        "IMEI": v.imei || "",
        "ICCID": v.iccid,
        "Renuevate/Kit/Chip/Porta": v.tipo,
        "#TIENDA / Determinante": v.tiendaNum,
        "SOLO NOMBRE DE LA CADENA": v.cadena,
        "SOLO NOMBRE DE TIENDA SIN CADENA": v.tiendaNom,
        "NOMBRE COMPLETO PROMOTOR": v.prom,
        "FECHA DE ACTIVACION": f,
        "MARCA": v.marca || "",
        "MODELO": v.mod || ""
      };
    });

    const ws = XLSX.utils.json_to_sheet(dataFormateada);
    ws['!cols'] = [
      { wch: 16 }, { wch: 18 }, { wch: 22 }, { wch: 26 },
      { wch: 22 }, { wch: 28 }, { wch: 32 }, { wch: 30 },
      { wch: 20 }, { wch: 16 }, { wch: 20 }
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Ventas");
    XLSX.writeFile(wb, "Reporte_Ventas_Telcel.xlsx");
  });
}

function menuInteractivo() {
  const eq = iTipo.value === 'KIT' || iTipo.value === 'RENUEVATE';
  seccionEquipo.classList.toggle('hidden', !eq);
  if (!eq) {
    iIme.value = "";
    iMarca.value = "";
    iMod.value = "";
  }
}

function verSeccion(id) {
  divLogin.classList.add('hidden');
  divReg.classList.add('hidden');
  document.getElementById(id).classList.remove('hidden');
}

function salir() {
  localStorage.clear();
  location.reload();
}
</script>
</body>
</html>
