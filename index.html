<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SISTEMA VENTAS 4029 - OFICIAL</title>

    <!-- SheetJS para crear Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script> <!-- [web:50][web:51] -->

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script> <!-- [web:58] -->

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #001220; margin: 0; color: #333; }
        .header { background: #003566; color: white; padding: 15px; text-align: center; border-bottom: 4px solid #ffc300; }
        .container { max-width: 450px; margin: auto; background: white; padding: 20px; min-height: 100vh; }
        .card { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        label { font-size: 11px; font-weight: bold; color: #003566; text-transform: uppercase; display: block; margin-bottom: 2px; }
        input, select, button { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
        button { background: #003566; color: white; font-weight: bold; border: none; cursor: pointer; }
        .btn-reg { background: #28a745; margin-top: 5px; }
        .btn-save { background: #28a745; font-size: 18px; margin-top: 10px; }
        .btn-excel { background: #217346; margin-top: 20px; height: 55px; font-size: 16px; color: #fff; }
        .hidden { display: none; }
        .reloj { font-size: 28px; font-weight: bold; color: #ffc300; text-align: center; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #003566; color: white; }
    </style>
</head>
<body onload="inicio()">

<!-- SECCI칍N LOGIN / REGISTRO -->
<div id="lSec" style="max-width:400px; margin:auto; padding:40px 20px; text-align:center;">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Telcel_logo.svg/1200px-Telcel_logo.svg.png" width="160">
    <div id="rel" class="reloj">00:00:00</div>

    <div id="divLogin">
        <input type="email" id="u" placeholder="Correo">
        <input type="password" id="p" placeholder="Contrase침a">
        <button onclick="entrar()">ENTRAR AL PANEL</button>
        <hr style="border: 0.5px solid #333; margin: 20px 0;">
        <button class="btn-reg" onclick="verSeccion('divReg')">NUEVO PROMOTOR</button>
    </div>

    <div id="divReg" class="hidden">
        <h3 style="color:white">CREAR CUENTA</h3>
        <input type="email" id="regEmail" placeholder="Correo">
        <input type="password" id="regPass" placeholder="Nueva Contrase침a">
        <button onclick="registrarUsuario()" style="background:#28a745;">FINALIZAR REGISTRO</button>
        <p onclick="verSeccion('divLogin')" style="color:#ffc300; cursor:pointer;">Volver</p>
    </div>
</div>

<!-- SECCI칍N PRINCIPAL DEL SISTEMA -->
<div id="mSec" class="hidden">
    <div class="header">
        <h3>SISTEMA VENTAS 4029</h3>
        <small style="color:#ffc300;">CONEXI칍N NUBE ACTIVA</small>
    </div>

    <div class="container">
        <form id="fReg">
            <label>Tr치mite</label>
            <select id="iTipo" onchange="menuInteractivo()" required>
                <option value="KIT">KIT (EQUIPO)</option>
                <option value="CHIP">CHIP</option>
                <option value="PORTA">PORTA</option>
                <option value="RENUEVATE">RENUEVATE</option>
            </select>

            <label>Celular (10 d칤gitos)</label>
            <input type="text" id="iTel" maxlength="10" required>

            <label>ICCID (19 d칤gitos)</label>
            <input type="text" id="iIcc" maxlength="19" required>

            <div id="seccionEquipo" class="card hidden">
                <label>IMEI (15 d칤gitos)</label>
                <input type="text" id="iIme" maxlength="15">
                <label>Modelo</label>
                <input type="text" id="iMod">
            </div>

            <div class="card">
                <label>Promotor</label>
                <input type="text" id="iProm" required>
                <label>Fecha</label>
                <input type="date" id="iFec">
            </div>

            <button type="submit" class="btn-save">游 GUARDAR VENTA</button>
        </form>

        <table id="tVistas">
            <thead>
                <tr><th>TEL칄FONO</th><th>TIPO</th><th>-</th></tr>
            </thead>
            <tbody></tbody>
        </table>

        <button onclick="bajarExcel()" class="btn-excel">游닌 DESCARGAR EXCEL</button>
        <button onclick="salir()" style="margin-top:20px; background:#6c757d; color:white;">SALIR</button>
    </div>
</div>

<script>
/* ==== CONFIGURACI칍N FIREBASE (CAMBIA ESTOS DATOS) ==== */
const firebaseConfig = {
    apiKey: "TU_API_KEY_AQU칈",
    databaseURL: "TU_URL_DE_DATABASE_AQU칈"
};
/* ===================================================== */

let uA = "";  // usuario actual (correo)
let db;

function inicio(){
    // Reloj
    setInterval(() => {
        document.getElementById('rel').innerText = new Date().toLocaleTimeString();
    }, 1000);

    // Fecha de hoy
    document.getElementById('iFec').value = new Date().toISOString().split('T')[0];

    // Inicializar Firebase
    if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
    db = firebase.database();

    // Sesi칩n guardada
    const s = localStorage.getItem('ses_actual');
    if (s){ uA = s; mostrar(); }
}

/* Registro de usuario */
function registrarUsuario(){
    const c = document.getElementById('regEmail').value.trim().toLowerCase();
    const p = document.getElementById('regPass').value.trim();
    if(!c || !p) return alert("Llena los campos.");

    const key = btoa(c).replace(/=/g,"");
    db.ref('usuarios/' + key).set({ p }).then(() => {
        alert("Registrado.");
        verSeccion('divLogin');
    });
}

/* Login */
function entrar(){
    const c = document.getElementById('u').value.trim().toLowerCase();
    const p = document.getElementById('p').value.trim();
    if(!c || !p) return alert("Ingresa correo y contrase침a.");

    const key = btoa(c).replace(/=/g,"");
    db.ref('usuarios/' + key).once('value').then((s) => {
        if(s.exists() && s.val().p === p){
            uA = c;
            localStorage.setItem('ses_actual', uA);
            mostrar();
        } else {
            alert("Datos incorrectos.");
        }
    });
}

/* Mostrar panel principal */
function mostrar(){
    document.getElementById('lSec').className = 'hidden';
    document.getElementById('mSec').className = '';
    pintarTabla();
}

/* Guardar venta */
document.getElementById('fReg').onsubmit = function(e){
    e.preventDefault();

    if(!iTel.value || !iIcc.value || !iProm.value){
        return alert("Completa los campos obligatorios.");
    }

    const key = btoa(uA).replace(/=/g,"");

    db.ref('ventas/' + key).push({
        tel: iTel.value,
        imei: iIme.value || "N/A",
        iccid: iIcc.value,
        tipo: iTipo.value,
        prom: iProm.value.toUpperCase(),
        fec: iFec.value,
        mod: iMod.value.toUpperCase() || "N/A"
    }).then(() => {
        alert("Venta guardada.");
        this.reset();
        document.getElementById('seccionEquipo').classList.add('hidden');
        // volver a poner fecha de hoy
        document.getElementById('iFec').value = new Date().toISOString().split('T')[0];
        pintarTabla();
    });
};

/* Tabla de 칰ltimas ventas */
function pintarTabla(){
    const key = btoa(uA).replace(/=/g,"");
    db.ref('ventas/' + key).limitToLast(5).on('value', (s) => {
        const tbody = document.querySelector('#tVistas tbody');
        tbody.innerHTML = "";
        s.forEach(child => {
            const x = child.val();
            tbody.innerHTML += `
                <tr>
                    <td>${x.tel}</td>
                    <td>${x.tipo}</td>
                    <td><button onclick="borrar('${child.key}')" style="background:red; color:white; border:none; padding:4px 8px; border-radius:4px;">X</button></td>
                </tr>`;
        });
    });
}

/* Borrar venta */
function borrar(id){
    const key = btoa(uA).replace(/=/g,"");
    if(confirm("쮼liminar esta venta?")){
        db.ref('ventas/'+key+'/'+id).remove();
    }
}

/* Descargar Excel con formato sencillo (sin comisiones) */
function bajarExcel(){
    const key = btoa(uA).replace(/=/g,"");
    db.ref('ventas/' + key).once('value').then((s) => {
        const ventas = Object.values(s.val() || {});

        const datosExcel = ventas.map(v => ({
            "FECHA": v.fec || "",
            "NUM CELULAR": v.tel || "",
            "ICCID": v.iccid || "",
            "IMEI": v.imei || "",
            "MODELO": v.mod || "",
            "TIPO TR츼MITE": v.tipo || "",
            "PROMOTOR": v.prom || ""
        }));

        const ws = XLSX.utils.json_to_sheet(datosExcel);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ventas");
        XLSX.writeFile(wb, "Ventas_Telcel_4029.xlsx");
    });
}

/* Mostrar / ocultar secci칩n equipo seg칰n tr치mite */
function menuInteractivo(){
    const t = document.getElementById('iTipo').value;
    document.getElementById('seccionEquipo')
        .classList.toggle('hidden', !(t === 'KIT' || t === 'RENUEVATE'));
}

/* Cambiar entre login y registro */
function verSeccion(id){
    document.getElementById('divLogin').classList.add('hidden');
    document.getElementById('divReg').classList.add('hidden');
    document.getElementById(id).classList.remove('hidden');
}

/* Cerrar sesi칩n */
function salir(){
    localStorage.clear();
    location.reload();
}
</script>
</body>
</html>