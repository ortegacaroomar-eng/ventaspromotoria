<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SISTEMA VENTAS - OFICIAL</title>

<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{font-family:Segoe UI;background:#001220;margin:0}
.container{max-width:450px;margin:auto;background:#fff;padding:20px}
button{width:100%;padding:12px;margin-top:10px;background:#003566;color:#fff;border:none;border-radius:8px}
.hidden{display:none}
table{border-collapse:collapse;width:100%;font-size:11px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
</style>
</head>

<body onload="inicio()">

<div id="lSec">
<input type="email" id="u" placeholder="Correo">
<input type="password" id="p" placeholder="ContraseÃ±a">
<button onclick="entrar()">ENTRAR</button>
</div>

<div id="mSec" class="hidden">
<div class="container">

<form id="fReg">
<input id="iTel" placeholder="NUM CELULAR" required>
<input id="iIcc" placeholder="ICCID" required>

<select id="iTipo" required>
<option value="">TIPO</option>
<option>KIT</option>
<option>CHIP</option>
<option>PORTA</option>
<option>RENUEVATE</option>
</select>

<input id="iIme" placeholder="IMEI">
<input id="iMarca" placeholder="MARCA">
<input id="iMod" placeholder="MODELO">

<input id="iTiendaNum" placeholder="TIENDA" required>
<input id="iCadena" placeholder="CADENA" required>
<input id="iTiendaNombre" placeholder="NOMBRE TIENDA" required>
<input id="iProm" placeholder="PROMOTOR" required>
<input type="date" id="iFec" required>

<button>GUARDAR</button>
</form>

<hr>

<table id="tVistas">
<thead>
<tr>
<th>NUM</th>
<th>IMEI</th>
<th>ICCID</th>
<th>TIPO</th>
<th>TIENDA</th>
<th>CADENA</th>
<th>NOMBRE</th>
<th>PROM</th>
<th>FECHA</th>
<th>MARCA</th>
<th>MODELO</th>
<th>X</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button onclick="bajarExcel()">DESCARGAR EXCEL FORMATO ORIGINAL</button>

</div>
</div>

<script>
const firebaseConfig={
apiKey:"AIzaSy",
databaseURL:"https://ventastelcel4029-default-rtdb.firebaseio.com"
}

let uA="",db

function inicio(){
firebase.initializeApp(firebaseConfig)
db=firebase.database()
iFec.value=new Date().toISOString().split('T')[0]
}

function entrar(){
uA=u.value
lSec.className="hidden"
mSec.className=""
pintarTabla()
}

fReg.onsubmit=e=>{
e.preventDefault()

const venta={
tel:iTel.value,
iccid:iIcc.value,
tipo:iTipo.value,
tiendaNum:iTiendaNum.value,
cadena:iCadena.value,
tiendaNom:iTiendaNombre.value,
prom:iProm.value,
fec:iFec.value,
imei:iIme.value||"",
marca:iMarca.value||"",
mod:iMod.value||""
}

db.ref('ventas/'+btoa(uA)).push(venta).then(()=>{
fReg.reset()
iFec.value=new Date().toISOString().split('T')[0]
pintarTabla()
})
}

function pintarTabla(){
db.ref('ventas/'+btoa(uA)).once('value',s=>{
const tb=document.querySelector('#tVistas tbody')
tb.innerHTML=""
s.forEach(c=>{
const v=c.val()
tb.innerHTML+=`
<tr>
<td>${v.tel}</td>
<td>${v.imei}</td>
<td>${v.iccid}</td>
<td>${v.tipo}</td>
<td>${v.tiendaNum}</td>
<td>${v.cadena}</td>
<td>${v.tiendaNom}</td>
<td>${v.prom}</td>
<td>${v.fec}</td>
<td>${v.marca}</td>
<td>${v.mod}</td>
<td><button onclick="borrar('${c.key}')">X</button></td>
</tr>`
})
})
}

function borrar(id){
db.ref('ventas/'+btoa(uA)+'/'+id).remove().then(pintarTabla)
}

/* ===========================================
   EXPORTAR USANDO TU PLANTILLA REAL EXACTA
   =========================================== */

async function bajarExcel(){

// cargar plantilla original
const res=await fetch("omarcitoo2026.xlsx")
const buffer=await res.arrayBuffer()

const wb=XLSX.read(buffer,{type:"array"})
const hoja=wb.SheetNames[0]
const ws=wb.Sheets[hoja]

// obtener datos firebase
const snap=await db.ref('ventas/'+btoa(uA)).once('value')
const datos=Object.values(snap.val()||{})

// fila donde empiezan registros (debajo encabezados)
let fila=2

datos.forEach(v=>{
ws["A"+fila]={t:"s",v:v.tel}
ws["B"+fila]={t:"s",v:v.imei||""}
ws["C"+fila]={t:"s",v:v.iccid}
ws["D"+fila]={t:"s",v:v.tipo}
ws["E"+fila]={t:"s",v:v.tiendaNum}
ws["F"+fila]={t:"s",v:v.cadena}
ws["G"+fila]={t:"s",v:v.tiendaNom}
ws["H"+fila]={t:"s",v:v.prom}
ws["I"+fila]={t:"s",v:v.fec}
ws["J"+fila]={t:"s",v:v.marca||""}
ws["K"+fila]={t:"s",v:v.mod||""}
fila++
})

// descargar archivo manteniendo formato
XLSX.writeFile(wb,"Reporte_Ventas_Telcel.xlsx")
}
</script>

</body>
</html>