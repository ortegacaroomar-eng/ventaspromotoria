<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SISTEMA VENTAS 4029 - OFICIAL</title>

<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{font-family:'Segoe UI',sans-serif;background:#001220;margin:0}
.header{background:#003566;color:#fff;padding:15px;text-align:center;border-bottom:4px solid #ffc300}
.container{max-width:450px;margin:auto;background:#fff;padding:20px;min-height:100vh}
.card{background:#f8f9fa;border:1px solid #dee2e6;padding:15px;border-radius:12px;margin-bottom:15px}
label{font-size:11px;font-weight:bold;color:#003566;text-transform:uppercase}
input,select,button{width:100%;padding:12px;margin-bottom:12px;border:1px solid #ccc;border-radius:8px;font-size:15px}
button{background:#003566;color:#fff;font-weight:bold;border:none}
.btn-reg{background:#28a745}
.btn-save{background:#28a745;font-size:18px}
.btn-excel{background:#217346;height:55px;font-size:16px}
.hidden{display:none}
.reloj{font-size:28px;font-weight:bold;color:#ffc300;text-align:center;margin:10px 0}

/* TABLA */
.tabla-scroll{
  overflow-x:auto;
  width:100%;
  margin-top:15px;
  border:1px solid #ddd;
  border-radius:8px;
}

table{
  border-collapse:collapse;
  min-width:500px;
  font-size:10px;
}

th,td{
  border:1px solid #ddd;
  padding:8px;
  white-space:nowrap;
}

th{background:#003566;color:#fff}
</style>
</head>

<body onload="inicio()">

<!-- LOGIN -->
<div id="lSec" style="max-width:400px;margin:auto;padding:40px 20px;text-align:center;">
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/Telcel_logo.svg/1200px-Telcel_logo.svg.png" width="160">
<div id="rel" class="reloj">00:00:00</div>

<div id="divLogin">
<input type="email" id="u" placeholder="Correo">
<input type="password" id="p" placeholder="Contraseña">
<button onclick="entrar()">ENTRAR</button>
<hr>
<button class="btn-reg" onclick="verSeccion('divReg')">NUEVO PROMOTOR</button>
</div>

<div id="divReg" class="hidden">
<h3 style="color:white">CREAR CUENTA</h3>
<input type="email" id="regEmail" placeholder="Correo">
<input type="password" id="regPass" placeholder="Contraseña">
<button class="btn-reg" onclick="registrarUsuario()">REGISTRAR</button>
<p onclick="verSeccion('divLogin')" style="color:#ffc300;cursor:pointer">Volver</p>
</div>
</div>

<!-- PANEL -->
<div id="mSec" class="hidden">
<div class="header">
<h3>SISTEMA VENTAS 4029</h3>
<small style="color:#ffc300">NUBE ACTIVA</small>
</div>

<div class="container">
<form id="fReg">

<label>Trámite</label>
<select id="iTipo" onchange="menuInteractivo()" required>
<option value="KIT">KIT</option>
<option value="CHIP">CHIP</option>
<option value="PORTA">PORTA</option>
<option value="RENUEVATE">RENUEVATE</option>
</select>

<label>Celular</label>
<input type="text" id="iTel" maxlength="10" required>

<label>ICCID</label>
<input type="text" id="iIcc" maxlength="19" required>

<div id="seccionEquipo" class="card hidden">
<label>IMEI</label>
<input type="text" id="iIme" maxlength="15">
<label>Modelo</label>
<input type="text" id="iMod">
</div>

<div class="card">
<label>Promotor</label>
<input type="text" id="iProm" required>
<label>Fecha</label>
<input type="date" id="iFec">
</div>

<button class="btn-save">GUARDAR VENTA</button>
</form>

<div class="tabla-scroll">
<table id="tVistas">
<thead>
<tr>
  <th>TEL</th>
  <th>TIPO</th>
  <th>-</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<button class="btn-excel" onclick="bajarExcel()">DESCARGAR EXCEL</button>
<button onclick="salir()" style="background:#6c757d;margin-top:20px">SALIR</button>
</div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyD4UK_j8UxMwOCtrtXIYftB",
  databaseURL: "https://ventastelcel4029-default-rtdb.firebaseio.com"
};

let uA="", db;

function inicio(){
  setInterval(()=>rel.innerText=new Date().toLocaleTimeString(),1000);
  iFec.value=new Date().toISOString().split('T')[0];
  if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  db=firebase.database();
  const s=localStorage.getItem('ses_actual');
  if(s){uA=s;mostrar();}
}

function registrarUsuario(){
  const c=regEmail.value.trim().toLowerCase();
  const p2=regPass.value.trim();
  if(!c||!p2) return alert("Campos vacíos");
  db.ref('usuarios/'+btoa(c)).set({p:p2}).then(()=>alert("Registrado"));
  verSeccion('divLogin');
}

function entrar(){
  const c=u.value.trim().toLowerCase();
  const p2=p.value.trim();
  db.ref('usuarios/'+btoa(c)).once('value').then(s=>{
    if(s.exists()&&s.val().p===p2){
      uA=c;
      localStorage.setItem('ses_actual',uA);
      mostrar();
    }else alert("Datos incorrectos");
  });
}

function mostrar(){
  lSec.className='hidden';
  mSec.className='';
  pintarTabla();
}

fReg.onsubmit=e=>{
  e.preventDefault();
  const venta={
    tel:iTel.value,
    iccid:iIcc.value,
    tipo:iTipo.value,
    prom:iProm.value.toUpperCase(),
    fec:iFec.value
  };
  if(iTipo.value==='KIT'||iTipo.value==='RENUEVATE'){
    if(iIme.value) venta.imei=iIme.value;
    if(iMod.value) venta.mod=iMod.value.toUpperCase();
  }
  db.ref('ventas/'+btoa(uA)).push(venta).then(()=>{
    alert("Venta guardada");
    fReg.reset();
    iFec.value=new Date().toISOString().split('T')[0];
    menuInteractivo();
    pintarTabla();
  });
};

function pintarTabla(){
  db.ref('ventas/'+btoa(uA)).limitToLast(5).once('value',s=>{
    const tb=document.querySelector('#tVistas tbody');
    tb.innerHTML="";
    s.forEach(c=>{
      tb.innerHTML+=`
      <tr>
        <td>${c.val().tel}</td>
        <td>${c.val().tipo}</td>
        <td><button onclick="borrar('${c.key}')" style="background:red;color:white">X</button></td>
      </tr>`;
    });
  });
}

function borrar(id){
  if(confirm("Eliminar venta"))
    db.ref('ventas/'+btoa(uA)+'/'+id).remove().then(pintarTabla);
}

function bajarExcel(){
  db.ref('ventas/'+btoa(uA)).once('value',s=>{
    const data=Object.values(s.val()||{});
    const ws=XLSX.utils.json_to_sheet(data);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Ventas");
    XLSX.writeFile(wb,"Ventas_4029.xlsx");
  });
}

function menuInteractivo(){
  const eq=iTipo.value==='KIT'||iTipo.value==='RENUEVATE';
  seccionEquipo.classList.toggle('hidden',!eq);
  iIme.required=eq;
}

function verSeccion(id){
  divLogin.classList.add('hidden');
  divReg.classList.add('hidden');
  document.getElementById(id).classList.remove('hidden');
}

function salir(){
  localStorage.clear();
  location.reload();
}
</script>

</body>
</html>